<aura:component implements="flexipage:availableForAllPageTypes,force:lightningQuickActionWithoutHeader" controller="BotController" access="global">

    <aura:attribute name="question" type="String" default=""/>
    <aura:attribute name="messages" type="Object[]"/>
    <aura:attribute name="session" type="Array"/>
    <aura:attribute name="height" type="String" default="500px" access="global"/>
    <aura:attribute name="files" type="Object[]"/>


    <ltng:require scripts="{!$Resource.cometd}" afterScriptsLoaded="{!c.onCometdLoaded}"/>
    <aura:attribute name="cometd" type="Object"/>
    <aura:attribute name="cometdSubscriptions" type="Object[]"/>
    <aura:attribute name="isMuted" type="Boolean" default="false"/>
    <aura:attribute name="sessionId" type="String"/>

    <aura:attribute name="fileName" type="String" default=""/>
    <aura:attribute name="attachmentURL" type="String" default=""/>
    <aura:attribute name="attachmentContent" type="String" default="" />
    <aura:attribute name="booleanFlag" type="Boolean" default="true" />

    <aura:attribute name="sentHistory" type="String[]"/>
    <aura:attribute name="lastHistoryIndex" type="Integer" default="0"/>
    <aura:attribute name="inputMessageValue" type="String" default="" />
    <aura:attribute name="userInfo" type="String[]"/>

    <aura:handler name="init" value="{!this}" action="{!c.doInit}"/>


    <style>
        .custom-a-color{color: #5d7193; text-decoration: none}
	</style>

    <div style="{#'height: '+v.height}" class="slds-p-vertical--x-small">
		<div aura:id="content" class="content">
	        <aura:iteration items="{!v.messages}" var="message">

                <lightning:layout >
                <lightning:layoutitem class="message_avatar" padding="around-small">
                  <span class="slds-avatar">
                   <aura:if isTrue="{#message.author == 'Me'}">
                       <img src="{!v.userInfo[0]}"/>
                       <aura:set attribute="else">
                            <img src="{!$Resource.altiLogo}"/>
                       </aura:set>
                   </aura:if>
                 </span>
               </lightning:layoutitem>

					<aura:if isTrue="{#message.author == 'Leah'}">
                        <lightning:layoutitem class="border-custom slds-border--bottom slds-theme--info slds-m-around--small" padding="around-small" flexibility="grow">
                        <p><strong>{#message.author}</strong></p>

                            <aura:unescapedHtml value="{#message.messageText}" />

                        <aura:if isTrue="{!message.imageURL}">
                            <figure class="slds-image slds-image--card slds-m-top--x-small">
                                <img src='{#message.imageURL}'/>
                            </figure>
                        </aura:if>

                        <aura:iteration items="{!message.buttons}" var="button">
                            <lightning:button label="{#button.label}" name="{#button.value}" onclick="{!c.postbackButtonClickHandler}" class="message-button"/>
                        </aura:iteration>

                        <aura:iteration items="{!message.records}" var="record">
                            <dl class="slds-list--horizontal slds-wrap">
                                <aura:iteration items="{!record.fields}" var="field">
                                    <dt class="slds-item--label slds-text-color--weak slds-truncate">{!field.name}:</dt>
                                    <dd class="slds-item--detail slds-truncate">
                                        <aura:if isTrue="{!field.linkURL}">
                                            <a href="{#field.linkURL}">{#field.value}</a>
                                            <aura:set attribute="else">
                                                {#field.value}
                                            </aura:set>
                                        </aura:if>
                                    </dd>
                                </aura:iteration>
                            </dl>
                        </aura:iteration>
					<aura:if isTrue="{!message.items}">
                      <lightning:layoutitem class="border-custom-layout custom-background slds-m-around--small" padding="around-small" flexibility="grow">
                        <aura:iteration items="{!message.items}" var="item">
                            <aura:if isTrue="{!item.linkURL}">
                                 <div class="slds-border--bottom slds-m-bottom--xx-small">
                                     <a class="custom-a-color" href="{!item.linkURL}"># {#item.name}</a>
                                 </div>

                                <aura:set attribute="else">
                                    <div class="list-item">{#item.name}</div>
                                </aura:set>
                            </aura:if>
                        </aura:iteration>
                      </lightning:layoutitem>
					</aura:if>
                    </lightning:layoutitem>

                        <aura:set attribute="else">
                            <lightning:layoutitem class="slds-border--bottom slds-border--left slds-border--right slds-border--top slds-theme--shade slds-m-around--small" padding="around-small" flexibility="grow">
                        	<p><strong>{#message.author}</strong></p>
                       		<p class="slds-text-body">{#message.messageText}</p>
                        <aura:if isTrue="{!message.imageURL}">
                            <figure class="slds-image slds-image--card slds-m-top--x-small">
                                <img src='{#message.imageURL}'/>
                            </figure>
                        </aura:if>

                        <aura:iteration items="{!message.buttons}" var="button">
                            <lightning:button label="{#button.label}" name="{#button.value}" onclick="{!c.postbackButtonClickHandler}" class="message-button"/>
                        </aura:iteration>

                        <aura:iteration items="{!message.records}" var="record">
                            <dl class="slds-list--horizontal slds-wrap">
                                <aura:iteration items="{!record.fields}" var="field">
                                    <dt class="slds-item--label slds-text-color--weak slds-truncate">{!field.name}:</dt>
                                    <dd class="slds-item--detail slds-truncate">
                                        <aura:if isTrue="{!field.linkURL}">
                                            <a href="{#field.linkURL}">{#field.value}</a>
                                            <aura:set attribute="else">
                                                {#field.value}
                                            </aura:set>
                                        </aura:if>
                                    </dd>
                                </aura:iteration>
                            </dl>
                        </aura:iteration>

                        <aura:iteration items="{!message.items}" var="item">
                            <aura:if isTrue="{!item.linkURL}">
                                <div class="list-item"><a href="{#item.linkURL}" target="_blank">{#item.name}</a></div>
                                <aura:set attribute="else">
                                    <div class="list-item">{#item.name}</div>
                                </aura:set>
                            </aura:if>
                        </aura:iteration>

                    </lightning:layoutitem>

                        </aura:set>

                    </aura:if>

                </lightning:layout>

            </aura:iteration>

        </div>

        <div class="footer slds-form-element slds-p-horizontal--small">
            <div class="slds-form-element__control">
                <input type="text"
                       class="slds-input"
                       placeholder="Provide feedback..."
                       onkeypress="{!c.utteranceHandler}"
                       onkeydown="{!c.keyDownHandler}"
                       value="{!v.inputMessageValue}"
                       updateOn="keydown"
                       />

            </div>

                <div class="slds-form-element__control">
                    <aura:if isTrue="{!v.booleanFlag}">

                		<lightning:input aura:id="fileInput"
                                 type="file" name="file"
                                 multiple="false"
                                 accept="image/*;capture=camera"
                                 files="{!v.files}"
                                 onchange="{!c.loadFile}"
                         		 label="Select a file"
                                 />

                        </aura:if>

                <aura:if isTrue="{!v.fileName != ''}">
                  <div>
                    <p class="slds-text-body slds-truncate">*Attachment: "<strong>{!v.fileName}</strong>"
                    	<lightning:buttonIcon class="slds-button slds-input__icon slds-text-color--default"
    								  iconName="utility:close" variant="bare"
    								  alternativeText="Send Feedback"
                                      onclick="{!c.detachFile}"/>
                    </p>
                  </div>
                    <aura:set attribute="else">
                        <p><span class="slds-hidden">.</span></p>
                    </aura:set>
                </aura:if>
            </div>
        </div>

    </div>

</aura:component>
